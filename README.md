# Anno Mark Bot

Async service that combines a Telegram bot for annotation workflows and a FastAPI webhook endpoint that reacts to events from Nextcloud. The project relies on aiogram v3, Dishka for DI, Postgres + SQLAlchemy (async), and Redis-backed FSM storage.

## Features
- Telegram bot with Aiogram 3 and Redis FSM storage for annotators and validators.
- FastAPI app that receives and processes Nextcloud webhook notifications.
- Async SQLAlchemy stack with Alembic migrations for persistence.
- Multi-stage Docker image and Docker Compose stack (Postgres + Redis + app) ready for production-like environments.

## Requirements
- Python 3.13
- [uv](https://docs.astral.sh/uv/) package manager (preferred) or pip
- PostgreSQL 14+ and Redis 6+ (local services or containers)

## Quick Start (uv)
1. Install dependencies:
   ```bash
   uv sync
   ```
2. Create a working environment file:
   ```bash
   cp example.env .env
   ```
   Fill in secrets (Telegram token, Nextcloud credentials, DB/Redis connection details, etc.).
3. Apply database migrations:
   ```bash
   uv run alembic upgrade head
   ```
4. Run the combined bot + API:
   ```bash
   uv run python main.py
   ```
   The FastAPI app will be available on `http://127.0.0.1:8000`.

To launch only the HTTP API, run:
```bash
uv run uvicorn main:app --host 0.0.0.0 --port 8000 --workers 1
```

## Docker Workflow
- Build the image:
  ```bash
  docker build -t anno-mark-bot .
  ```
- Copy the example environment and adjust values:
  ```bash
  cp example.env .env
  cp docker-compose.example.yml docker-compose.yml
  ```
- Run migrations:
  ```bash
  docker compose run --rm app bash -lc "/app/.venv/bin/python -m alembic upgrade head"
  ```
- Start the app:
  ```bash
  docker compose up -d
  ```

## Environment Variables
All configuration is read via `core.config.Settings` and the `.env` file. Key variables:

| Variable | Description |
| --- | --- |
| `LOG_LEVEL` | Logging verbosity (`DEBUG`, `INFO`, `WARNING`, `ERROR`). |
| `NEXTCLOUD_WEBHOOK_TOKEN` | Token shared with Nextcloud for validating webhook calls. |
| `NEXTCLOUD_WEBDAV_URL` | Base WebDAV URL (e.g., `https://example.com/remote.php/dav/files/user/`). |
| `NEXTCLOUD_AUTH` | JSON-like list with login/password, e.g. `["user", "pass"]`. |
| `NEXTCLOUD_DIRECTORIES` | JSON-like list of Nextcloud directories to watch. |
| `NEXTCLOUD_OCS_URL` | OCS API base for Nextcloud app management. |
| `DATABASE_HOST`, `DATABASE_PORT` | Postgres host and port (use `postgres` inside Docker). |
| `DATABASE_USER`, `DATABASE_PASSWORD`, `DATABASE_NAME`, `DATABASE_SCHEMA` | Postgres credentials/database. |
| `DATABASE_ECHO` | `true/false`; enables SQLAlchemy SQL echo. |
| `BOT_TOKEN` | Telegram bot token. |
| `BOT_SECRET` | Secret used for deep links/registration. |
| `BOT_DEEP_LINK_TTL` | Seconds before generated deep links expire. |
| `BOT_DEEP_LINK_TAG_LEN` | Length of generated deep-link tags. |
| `REDIS_HOST`, `REDIS_PORT` | Redis connection info (use `redis` in Docker). |
| `REDIS_PASSWORD` | Password if Redis is secured, empty otherwise. |
| `REDIS_DB` | Redis database index. |
| `ITERATION_LIMIT` | Annotation iteration limit for the annotator. |

Environment lists (like `NEXTCLOUD_DIRECTORIES`) should remain valid JSON-style arrays so they can be parsed correctly.

## Project Structure
- `main.py` – FastAPI application setup, bot polling lifecycle.
- `bot/` – Telegram handlers, FSM logic, admin/annotator flows.
- `web_api/` – FastAPI routers and services (e.g., Nextcloud webhook endpoint).
- `core/` – Configuration, dependency injection container, utilities.
- `alembic/` – Database migrations.

## Development Notes
- Preferred dependency manager is `uv`; lock file stored in `uv.lock`.
- Linting: Ruff, Mypy; managed through `pyproject.toml`.
- Logging is configured via `core/utils/logging_config.py` during startup.

### Creating a New Migration
1. Ensure models and alembic env are in sync. Review changes in `core/models`.
2. Generate the migration:
   ```bash
   uv run alembic revision --autogenerate -m "initial"
   ```
   Replace `"initial"` with a meaningful message.
3. Inspect the autogenerated script in `alembic/versions/`, adjust if necessary.
4. Apply it locally with `uv run alembic upgrade head`.
